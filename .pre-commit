#!/bin/sh

# Get staged files
STAGED_GO_FILES=$(git diff --cached --name-only --diff-filter=ACM | grep '\.go$')
STAGED_SV_FILES=$(git diff --cached --name-only --diff-filter=ACM | grep '\.sv$')
GODIRS='./cmd/... ./pkg/... ./internal/...'

# Run lint only if Go or SV files are staged
if [ -n "$STAGED_GO_FILES" ] || [ -n "$STAGED_SV_FILES" ]; then
  echo "Running linters on staged files..."
  if [ -n "$STAGED_GO_FILES" ]; then
    golangci-lint run --timeout 20s --color=always --fix $GODIRS || exit 1
  fi
  if [ -n "$STAGED_SV_FILES" ]; then
    for svfff in $STAGED_SV_FILES; do
      ./scripts/fix-indent.sh "$svfff" || exit 1
    done
  fi
fi

# Run tests only if Go test files are staged
STAGED_TEST_FILES=$(git diff --cached --name-only --diff-filter=ACM | grep '_test\.go$')
if [ -n "$STAGED_GO_FILES" ] || [ -n "$STAGED_TEST_FILES" ]; then
  echo "Running tests for staged files..."
  go test -parallel 1 -timeout 120s $GODIRS || exit 1
fi
